---
phase: 03-form-entegrasyonu-&-n8n-webhook
plan: 2
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - src/lib/forms/contactSchema.ts
  - src/lib/forms/submitContactForm.ts
  - src/components/forms/ContactForm.tsx
  - .env.local.example
autonomous: true

user_setup:
  - service: n8n
    why: "Form submissions must be sent to n8n webhook for lead processing"
    env_vars:
      - name: NEXT_PUBLIC_N8N_WEBHOOK_URL
        source: "n8n instance at https://ai.mokadijital.com — create webhook workflow and get URL"
    dashboard_config:
      - task: "Create webhook workflow in n8n"
        location: "n8n Dashboard -> Create new workflow -> Add Webhook trigger -> Copy production URL"

must_haves:
  truths:
    - "Zod schema validates all form fields (isim, telefon, email, sirket required)"
    - "Email field uses regex validation for valid email format"
    - "Phone field validates Turkish phone format (optional: +90 or 10 digits)"
    - "Form submit handler sends POST request to NEXT_PUBLIC_N8N_WEBHOOK_URL"
    - "Submit handler includes form data + metadata (timestamp, page, source, service)"
    - "On submit success, success state is set and modal auto-closes after 3 seconds"
    - "On submit error, error state is set with user-friendly message"
  artifacts:
    - path: "src/lib/forms/contactSchema.ts"
      provides: "Zod validation schema for contact form"
      min_lines: 30
      exports: ["contactSchema", "ContactFormData"]
    - path: "src/lib/forms/submitContactForm.ts"
      provides: "Form submit handler with n8n webhook integration"
      min_lines: 50
      exports: ["submitContactForm"]
    - path: ".env.local.example"
      provides: "Environment variable template"
      min_lines: 10
  key_links:
    - from: "src/lib/forms/submitContactForm.ts"
      to: "process.env.NEXT_PUBLIC_N8N_WEBHOOK_URL"
      via: "Environment variable read"
      pattern: "process\\.env\\.NEXT_PUBLIC_N8N_WEBHOOK_URL"
    - from: "src/lib/forms/submitContactForm.ts"
      to: "n8n webhook"
      via: "fetch POST request"
      pattern: "fetch\\(.*NEXT_PUBLIC_N8N_WEBHOOK_URL.*method.*POST"
    - from: "src/components/forms/ContactForm.tsx"
      to: "src/lib/forms/contactSchema.ts"
      via: "React Hook Form resolver"
      pattern: "resolver: zodResolver\\(contactSchema\\)"
---

<objective>
Add form validation with React Hook Form + Zod and integrate n8n webhook submission

**Purpose:** Implement form validation logic and backend integration. The Zod schema ensures data quality, React Hook Form manages form state, and the n8n webhook sends leads to the automation system.

**Output:**
- Zod validation schema for all form fields
- React Hook Form integration in ContactForm
- n8n webhook submit handler with metadata
- Environment variable template
</objective>

<execution_context>
@C:\Users\Omer\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\Omer\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-form-entegrasyonu-&-n8n-webhook/03-CONTEXT.md
@src/components/forms/ContactForm.tsx

# Prior Phase Context
@.planning/phases/03-form-entegrasyonu-&-n8n-webhook/03-01-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Create Zod validation schema for contact form</name>
  <files>src/lib/forms/contactSchema.ts</files>
  <action>
    Create Zod validation schema for the contact form:

    **Location:** `src/lib/forms/contactSchema.ts` (30-50 lines)

    **Schema definition:**
    ```typescript
    import { z } from 'zod'

    // Turkish phone validation: optional +90 prefix, then 10 digits
    // Formats accepted: +905551234567, 05551234567, 5551234567
    const turkishPhoneRegex = /^(\+90|0)?[0-9]{10}$/

    export const contactSchema = z.object({
      isim: z.string()
        .min(2, 'İsim en az 2 karakter olmalıdır')
        .max(50, 'İsim en fazla 50 karakter olabilir'),
      telefon: z.string()
        .regex(turkishPhoneRegex, 'Geçerli bir Türk telefon numarası giriniz'),
      email: z.string()
        .email('Geçerli bir e-posta adresi giriniz'),
      sirket: z.string()
        .min(2, 'Şirket adı en az 2 karakter olmalıdır')
        .max(100, 'Şirket adı en fazla 100 karakter olabilir'),
      website: z.string().url('Geçerli bir web sitesi adresi giriniz').optional().or(z.literal('')),
      mesaj: z.string()
        .max(500, 'Mesaj en fazla 500 karakter olabilir')
        .optional(),
      gizlilik: z.literal(true, {
        errorMap: () => ({ message: 'Gizlilik politikasını kabul etmeniz gerekmektedir' })
      }),
      service: z.string().optional() // Hidden field for lead tracking
    })
    ```

    **Type export:**
    ```typescript
    export type ContactFormData = z.infer<typeof contactSchema>
    ```

    **Notes:**
    - Use Turkish error messages for better UX
    - Phone regex should be lenient enough for common Turkish formats
    - Website field is optional (or empty string)
    - gizlilik must be exactly `true` (checked checkbox value)
    - service field is optional for pages that don't specify it

    Add comments explaining the validation rules for future maintenance.
  </action>
  <verify>
    - TypeScript compiles without errors
    - Schema can be imported: `import { contactSchema } from '@/lib/forms/contactSchema'`
    - Type is exported: `import type { ContactFormData } from '@/lib/forms/contactSchema'`
  </verify>
  <done>
    Zod schema validates all required fields with Turkish error messages and proper regex patterns
  </done>
</task>

<task type="auto">
  <name>Create n8n webhook submit handler</name>
  <files>src/lib/forms/submitContactForm.ts</files>
  <action>
    Create form submission handler that sends data to n8n webhook:

    **Location:** `src/lib/forms/submitContactForm.ts` (50-80 lines)

    **Function signature:**
    ```typescript
    import { ContactFormData } from './contactSchema'

    export interface SubmitResult {
      success: boolean
      message: string
    }

    export async function submitContactForm(
      data: ContactFormData,
      metadata?: {
        page?: string
        source?: string
        userAgent?: string
      }
    ): Promise<SubmitResult>
    ```

    **Implementation:**
    1. **Get webhook URL from environment:**
       ```typescript
       const webhookUrl = process.env.NEXT_PUBLIC_N8N_WEBHOOK_URL
       if (!webhookUrl) {
         console.error('NEXT_PUBLIC_N8N_WEBHOOK_URL is not defined')
         return { success: false, message: 'Bir sorun oluştu, lütfen tekrar deneyin' }
       }
       ```

    2. **Prepare payload:**
       ```typescript
       const payload = {
         ...data,
         metadata: {
           timestamp: new Date().toISOString(),
           page: metadata?.page || window.location.pathname,
           source: metadata?.source || 'contact_form',
           userAgent: metadata?.userAgent || navigator.userAgent,
           referrer: document.referrer
         }
       }
       ```

    3. **Send POST request:**
       ```typescript
       try {
         const response = await fetch(webhookUrl, {
           method: 'POST',
           headers: {
             'Content-Type': 'application/json',
           },
           body: JSON.stringify(payload)
         })

         if (!response.ok) {
           throw new Error(`HTTP error! status: ${response.status}`)
         }

         return { success: true, message: 'Mesajınız başarıyla gönderildi' }
       } catch (error) {
         console.error('Form submission error:', error)
         return { success: false, message: 'Bir sorun oluştu, lütfen tekrar deneyin' }
       }
       ```

    4. **Error handling:**
       - Network errors: Return generic error message (don't expose technical details)
       - Timeout: Set reasonable timeout (maybe 10 seconds)
       - Log errors to console for debugging

    5. **CORS considerations:**
       - n8n webhook should be configured to allow CORS from the production domain
       - If CORS issues occur, document them for n8n configuration

    **Notes:**
    - This runs client-side (uses window, navigator, document)
    - Keep error messages user-friendly (Turkish)
    - Don't expose webhook URL in error messages
    - Log full errors to console for development debugging

    Add comments about n8n workflow expectations (what fields it should receive).
  </action>
  <verify>
    - Function can be imported and called without TypeScript errors
    - Return type matches SubmitResult interface
    - Environment variable is read correctly
  </verify>
  <done>
    submitContactForm function sends POST request to n8n webhook with form data and metadata
  </done>
</task>

<task type="auto">
  <name>Integrate React Hook Form into ContactForm component</name>
  <files>src/components/forms/ContactForm.tsx</files>
  <action>
    Update ContactForm component to use React Hook Form with Zod validation:

    **Changes to src/components/forms/ContactForm.tsx:**

    1. **Add imports:**
       ```typescript
       import { useForm } from 'react-hook-form'
       import { zodResolver } from '@hookform/resolvers/zod'
       import { contactSchema, type ContactFormData } from '@/lib/forms/contactSchema'
       import { submitContactForm } from '@/lib/forms/submitContactForm'
       ```

    2. **Initialize useForm:**
       ```typescript
       const {
         register,
 handleSubmit,
     formState: { errors, isSubmitting },
     setError,
     reset
   } = useForm<ContactFormData>({
     resolver: zodResolver(contactSchema),
     defaultValues: {
       isim: '',
       telefon: '',
       email: '',
       sirket: '',
       website: '',
       mesaj: '',
       gizlilik: false,
       service: serviceName || ''
     }
   })
       ```

    3. **Create submit handler:**
       ```typescript
       const onSubmit = async (data: ContactFormData) => {
     try {
       const result = await submitContactForm(data, {
         page: window.location.pathname,
         source: 'contact_form'
       })

       if (result.success) {
         // Show success message
         onSuccess?.() // Call parent success callback
         reset() // Clear form
       } else {
         // Show error message
         onError?.(result.message) // Call parent error callback
       }
     } catch (error) {
       onError?.('Bir sorun oluştu, lütfen tekrar deneyin')
     }
   }
       ```

    4. **Update form fields to use register:**
       - Replace controlled inputs with `{...register('fieldName')}`
       - Example: `<Input {...register('isim')} />`
       - Show error messages: `{errors.isim && <p className="text-red-500 text-sm">{errors.isim.message}</p>}`
       - Add error class to input: `className={cn(errors.isim && 'border-red-500')}`

    5. **Update gizlilik checkbox:**
       ```typescript
       <input
         type="checkbox"
         {...register('gizlilik')}
         className={cn('w-4 h-4 rounded', errors.gizlilik && 'border-red-500')}
       />
       ```

    6. **Update submit button:**
       - Disabled state: `disabled={isSubmitting || loading}`
       - Text: `{isSubmitting ? 'Gönderiliyor...' : 'Gönder'}`

    7. **Validation timing (Claude's discretion):**
       - Use default mode (validation on submit)
       - For better UX, add `mode: 'onBlur'` to show errors when user leaves field
       - This gives immediate feedback without being too aggressive

    8. **Remove loading/success/error props if now managed internally:**
       - Or keep them for parent component control
       - Recommendation: Keep props for flexibility, manage internal state too

    **Error message styling:**
    - Use existing design tokens: text-destructive or custom text-red-500
    - Place error message below each field
    - Add icon (AlertCircle from lucide-react) for better UX

    **Note:** The existing loading/success/error state handling from plan 03-01 should be preserved or enhanced.
  </action>
  <verify>
    - Form validation works: try invalid data, see error messages
    - Valid form submits successfully to n8n webhook (check network tab)
    - Submit button shows "Gönderiliyor..." during submission
    - Form clears after successful submission
    - Error message shows on failed submission
  </verify>
  <done>
    ContactForm uses React Hook Form with Zod validation and submits to n8n webhook
  </done>
</task>

<task type="auto">
  <name>Create environment variable template file</name>
  <files>.env.local.example</files>
  <action>
    Create .env.local.example template file:

    **Location:** `.env.local.example` (10-20 lines)

    **Content:**
    ```bash
    # n8n Webhook Configuration
    # Get your webhook URL from: https://ai.mokadijital.com
    # 1. Create a new workflow in n8n
    # 2. Add a Webhook trigger node
    # 3. Set method to POST
    # 4. Copy the "Production URL" (not "Test URL")
    # 5. Paste below

    NEXT_PUBLIC_N8N_WEBHOOK_URL=https://ai.mokadijital.com/webhook/your-webhook-path

    # Optional: Add other environment variables below
    # NEXT_PUBLIC_SITE_URL=https://mokadijital.com
    ```

    **Additional notes:**
    - Include instructions on how to get the webhook URL
    - Mention that .env.local should never be committed to git
    - Already in .gitignore (verify)
  </action>
  <verify>
    - .env.local.example exists in project root
    - File contains NEXT_PUBLIC_N8N_WEBHOOK_URL with placeholder
    - Instructions are clear for getting the webhook URL
  </verify>
  <done>
    .env.local.example template exists with NEXT_PUBLIC_N8N_WEBHOOK_URL and setup instructions
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify:
1. contactSchema.ts has validation rules for all form fields
2. submitContactForm.ts can be imported and called
3. ContactForm integrates React Hook Form with proper error display
4. Form submission sends POST request to n8n webhook with correct payload
5. Environment variable template is documented
6. Error messages are in Turkish and user-friendly
7. Success path clears form and shows success message
</verification>

<success_criteria>
1. Zod schema validates all form fields (isim, telefon, email, sirket required)
2. Email field uses regex validation for valid email format
3. Phone field validates Turkish phone format
4. Form submit handler sends POST request to NEXT_PUBLIC_N8N_WEBHOOK_URL
5. Submit handler includes form data + metadata (timestamp, page, source, service)
6. On submit success, success state is set and modal auto-closes after 3 seconds
7. On submit error, error state is set with user-friendly message
</success_criteria>

<output>
After completion, create `.planning/phases/03-form-entegrasyonu-&-n8n-webhook/03-02-SUMMARY.md`
</output>
